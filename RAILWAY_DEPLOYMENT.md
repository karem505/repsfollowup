# Railway Deployment Guide

This project is configured as a Railway template for easy one-click deployment with PostgreSQL.

## Quick Deploy

[![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/template/your-template-url)

## What Gets Deployed

When you deploy this template, Railway will automatically:

1. **Create a PostgreSQL Database**: A managed PostgreSQL instance
2. **Deploy the Web Application**: Your Node.js/Express backend + React frontend
3. **Configure Environment Variables**: Automatically set up database connections
4. **Build the Application**: Install dependencies and build the React frontend

## Environment Variables

The following environment variables are automatically configured:

### Auto-Generated by Railway
- `DATABASE_URL` - Connected to the PostgreSQL service (format: `postgresql://user:password@host:port/database`)
- `POSTGRES_PASSWORD` - PostgreSQL password from the Postgres service
- `JWT_SECRET` - Randomly generated secure token for JWT authentication
- `PORT` - Assigned by Railway (default: 5000)
- `NODE_ENV` - Set to "production"
- `CLIENT_URL` - Automatically set to `https://${{RAILWAY_PUBLIC_DOMAIN}}`
- `REACT_APP_API_URL` - Automatically set to `https://${{RAILWAY_PUBLIC_DOMAIN}}/api`

### Required Manual Input
- `GOOGLE_MAPS_API_KEY` - (Optional) You'll be prompted to enter this during deployment
  - Get your API key from: https://console.cloud.google.com/google/maps-apis
  - You can skip this and add it later if needed

## Post-Deployment Steps

### 1. Get Your Application URL
After deployment completes, Railway will provide you with a URL like:
```
https://your-app-name.up.railway.app
```

### 2. Verify Environment Variables
The following should be automatically set. To verify:

1. Go to your Railway project dashboard
2. Click on the "web" service
3. Navigate to "Variables" tab
4. Confirm these variables exist:
   - `DATABASE_URL` (from Postgres service)
   - `POSTGRES_PASSWORD` (from Postgres service)
   - `CLIENT_URL` (should be your Railway domain)
   - `REACT_APP_API_URL` (should be your Railway domain + /api)
   - `JWT_SECRET` (auto-generated)
   - `NODE_ENV=production`

### 3. Set Up Google Maps API Key (Optional)

If you didn't enter it during deployment:

1. Get your API key from [Google Cloud Console](https://console.cloud.google.com/google/maps-apis)
2. In Railway dashboard, go to Variables
3. Add or update `GOOGLE_MAPS_API_KEY`

### 4. Database Initialization

The application will automatically:
- Connect to PostgreSQL using `DATABASE_URL`
- Create the necessary tables on first run (via `initializeDatabase()`)
- The database schema is defined in `server/config/database.js`

### 5. Create Admin User

After deployment, create an admin user through the registration endpoint:

**Using curl:**
```bash
curl -X POST https://your-app-name.up.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your-secure-password",
    "role": "admin"
  }'
```

Or access your app in a browser and use the registration form.

## Manual Deployment (Alternative)

If you want to deploy manually instead of using the template:

### Prerequisites
- Railway account ([sign up here](https://railway.app))
- Railway CLI (optional but recommended)

### Steps

1. **Install Railway CLI** (optional)
   ```bash
   npm i -g @railway/cli
   ```

2. **Clone the repository**
   ```bash
   git clone <your-repo-url>
   cd repsfollowup
   ```

3. **Login to Railway**
   ```bash
   railway login
   ```

4. **Initialize a new project**
   ```bash
   railway init
   ```

5. **Add PostgreSQL Plugin**
   ```bash
   railway add
   # Select "PostgreSQL" from the list
   ```

6. **Set environment variables**

   Railway will auto-populate most variables, but you can manually set:

   ```bash
   railway variables set JWT_SECRET=$(openssl rand -base64 32)
   railway variables set GOOGLE_MAPS_API_KEY=your-google-maps-api-key
   railway variables set NODE_ENV=production
   ```

   The following will be automatically linked from PostgreSQL service:
   - `DATABASE_URL=${{Postgres.DATABASE_URL}}`
   - `POSTGRES_PASSWORD=${{Postgres.PGPASSWORD}}`

7. **Link environment variables in Railway Dashboard**

   Go to your Railway dashboard â†’ Variables tab and add:
   - `DATABASE_URL` â†’ Reference â†’ `Postgres.DATABASE_URL`
   - `POSTGRES_PASSWORD` â†’ Reference â†’ `Postgres.PGPASSWORD`
   - `CLIENT_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}`
   - `REACT_APP_API_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}/api`

8. **Deploy**
   ```bash
   railway up
   ```

9. **Generate domain**
   ```bash
   railway domain
   ```

## Project Structure

```
.
â”œâ”€â”€ server/              # Express backend
â”‚   â”œâ”€â”€ index.js        # Main server file
â”‚   â”œâ”€â”€ config/         # Database configuration
â”‚   â”œâ”€â”€ routes/         # API routes
â”‚   â””â”€â”€ middleware/     # Authentication middleware
â”œâ”€â”€ client/             # React frontend
â”‚   â”œâ”€â”€ src/           # React source code
â”‚   â””â”€â”€ public/        # Static assets
â”œâ”€â”€ railway.json       # Railway deployment config (JSON format)
â”œâ”€â”€ railway.toml       # Railway build config (TOML format)
â”œâ”€â”€ template.yaml      # Railway template definition
â”œâ”€â”€ .env.example       # Example environment variables
â””â”€â”€ .env.railway       # Railway-specific env template
```

## Build Process

Railway automatically runs:

1. `npm install` - Install backend dependencies
2. `cd client && npm install` - Install frontend dependencies
3. `REACT_APP_API_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}/api npm run build` - Build React with correct API URL
4. `npm start` - Start the Express server

The Express server serves both the API and the built React application.

## Database Connection

The PostgreSQL connection is automatically configured through the `DATABASE_URL` environment variable, which Railway sets based on the PostgreSQL service.

**Connection String Format:**
```
postgresql://username:password@host:port/database
```

Railway automatically populates this from the Postgres service.

## Configuration Files Explained

### railway.json
JSON-based configuration for Railway deployment settings.

### railway.toml
TOML-based configuration with build and deploy commands.

### template.yaml
Defines the Railway template for one-click deployment, including:
- Service definitions (web app + PostgreSQL)
- Environment variable references
- Build and deploy commands
- Health check configuration

## Important Notes

### REACT_APP_API_URL
This environment variable **MUST** be set during the build process, not at runtime. React apps bake environment variables into the build. Railway automatically sets this in the build command:

```bash
REACT_APP_API_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}/api npm run build
```

### Database Migrations
The application uses `initializeDatabase()` to set up tables on first run. If you need to run migrations manually:

1. Access Railway CLI:
   ```bash
   railway run node server/config/database.js
   ```

2. Or connect to PostgreSQL directly:
   ```bash
   railway connect postgres
   ```

## Troubleshooting

### Build Failures

If your build fails:

1. **Check the build logs** in Railway dashboard â†’ Deployments â†’ Build Logs
2. **Common issues:**
   - Missing dependencies in `package.json`
   - Frontend build errors in `client/`
   - Environment variables not set during build

### Runtime Errors

1. **Check deployment logs** in Railway dashboard â†’ Deployments â†’ Deploy Logs
2. **Common issues:**
   - Database connection errors (verify `DATABASE_URL`)
   - Missing environment variables
   - Port conflicts (Railway sets `PORT` automatically)

### Database Connection Issues

1. **Verify PostgreSQL service is running**
   - Go to Railway dashboard â†’ Services â†’ Postgres
   - Check status is "Active"

2. **Verify environment variables**
   ```bash
   railway variables
   ```
   Should show `DATABASE_URL` pointing to Postgres service

3. **Test database connection**
   ```bash
   railway run node -e "const { Pool } = require('pg'); const pool = new Pool({ connectionString: process.env.DATABASE_URL }); pool.query('SELECT NOW()', (err, res) => { console.log(err, res); pool.end(); });"
   ```

### Frontend Not Loading

1. **Verify build completed successfully**
   - Check that `client/build/` directory was created during build
   - Look for "Build completed" in build logs

2. **Verify REACT_APP_API_URL was set during build**
   - Check build logs for the environment variable
   - Should show: `REACT_APP_API_URL=https://your-domain.railway.app/api`

3. **Check browser console**
   - Open browser DevTools â†’ Console
   - Look for API connection errors
   - Verify API calls are going to correct domain

### Health Check Failures

The app has a health check endpoint at `/api/health`. If Railway shows unhealthy:

1. **Test endpoint manually:**
   ```bash
   curl https://your-app.railway.app/api/health
   ```
   Should return: `{"status":"ok","message":"Server is running"}`

2. **Check health check settings** in `railway.json` or `railway.toml`:
   - Path: `/api/health`
   - Timeout: 100 seconds
   - Interval: 30 seconds

## Local Development

To run locally after cloning:

1. **Install dependencies**
   ```bash
   npm install
   cd client && npm install
   cd ..
   ```

2. **Set up environment variables**
   ```bash
   cp .env.example .env
   # Edit .env with your local values
   ```

3. **Run PostgreSQL locally**
   ```bash
   # Using Docker
   docker run -d \
     -p 5432:5432 \
     -e POSTGRES_USER=postgres \
     -e POSTGRES_PASSWORD=postgres \
     -e POSTGRES_DB=visit_tracker \
     --name visit-tracker-db \
     postgres:15

   # Or install PostgreSQL locally
   ```

4. **Create database**
   ```bash
   psql -U postgres -c "CREATE DATABASE visit_tracker;"
   ```

5. **Run development server**
   ```bash
   # Terminal 1 - Backend
   npm run dev

   # Terminal 2 - Frontend
   cd client && npm start
   ```

6. **Access the application**
   - Frontend: http://localhost:3000
   - Backend API: http://localhost:5000/api
   - Health check: http://localhost:5000/api/health

## Environment Variables Reference

### Production (Railway)
```bash
NODE_ENV=production
PORT=5000  # Auto-set by Railway
DATABASE_URL=${{Postgres.DATABASE_URL}}  # Auto-linked from Postgres service
POSTGRES_PASSWORD=${{Postgres.PGPASSWORD}}  # Auto-linked from Postgres service
CLIENT_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}
REACT_APP_API_URL=https://${{RAILWAY_PUBLIC_DOMAIN}}/api
JWT_SECRET=<auto-generated-or-set-manually>
GOOGLE_MAPS_API_KEY=<your-key-optional>
```

### Development (Local)
```bash
NODE_ENV=development
PORT=5000
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/visit_tracker
CLIENT_URL=http://localhost:3000
REACT_APP_API_URL=http://localhost:5000/api
JWT_SECRET=your-local-dev-secret
GOOGLE_MAPS_API_KEY=your-google-maps-key
```

## Support

For Railway-specific issues:
- [Railway Documentation](https://docs.railway.app)
- [Railway Discord](https://discord.gg/railway)
- [Railway Help Center](https://help.railway.app)

For application issues:
- Check the repository's GitHub Issues
- Review application logs in Railway dashboard

## Security Notes

1. **Never commit `.env` files** to version control
2. **Use strong JWT secrets** in production (Railway can auto-generate)
3. **Railway auto-generates secure database passwords** for Postgres
4. **Enable SSL** for production databases (Railway does this by default)
5. **Regularly update dependencies** for security patches
6. **Use environment-specific configurations** (dev vs production)

## Performance Tips

1. **Database connection pooling** is configured in `server/config/database.js`
2. **React production build** is optimized and minified
3. **Static assets** are served efficiently by Express
4. **Health checks** ensure application availability
5. **Auto-restart policy** handles transient failures

## Next Steps

After successful deployment:

1. âœ… Create admin user
2. âœ… Test all API endpoints
3. âœ… Verify database connections
4. âœ… Test Google Maps integration (if enabled)
5. âœ… Set up monitoring and alerts in Railway
6. âœ… Configure custom domain (optional)
7. âœ… Enable Railway metrics and logging

Congratulations! Your Visit Tracker app is now deployed on Railway with PostgreSQL! ðŸš€
